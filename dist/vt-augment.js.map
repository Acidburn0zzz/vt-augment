{"version":3,"file":"vt-augment.js","sourceRoot":"","sources":["../src/vt-augment.ts"],"names":[],"mappings":"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","sourcesContent":["import lscache from 'lscache';\n\nexport type VTAugmentOptions = {\n  mode?: 'drawer' | 'embedded',\n  background?: 'string',\n}\n\nexport interface HTMLIFrameIE11Compatible extends Omit<HTMLIFrameElement, 'srcdoc'> {\n  /* srcdoc property is not present in IE11 */\n  srcdoc?: string,\n}\n\nconst CSS_SCOPE = '4rrgf4';\n\nconst CSS_STYLESHEET = `\n  .vt-augment-${CSS_SCOPE} {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n  .vt-augment-${CSS_SCOPE}.drawer {\n    width: 700px;\n    background: white;\n    border: 1px solid #e6e6e6;\n    text-align: left;\n    z-index: 102;\n    position: fixed;\n    right: 0;\n    top: 0;\n    height: 100vh;\n    box-shadow: -4px 5px 8px -3px rgba(17, 17, 17, .16);\n    animation: slideToRight-${CSS_SCOPE} 0.5s 1 forwards;\n    transform: translateX(100vw);\n  }\n  .vt-augment-${CSS_SCOPE}.drawer[opened] {\n    animation: slideFromRight-${CSS_SCOPE} 0.2s 1 forwards;\n  }\n  .vt-augment-${CSS_SCOPE} > .spinner {\n    border: 8px solid rgba(0, 0, 0, 0.2);\n    border-left-color: white;\n    border-radius: 50%;\n    width: 50px;\n    height: 50px;\n    animation: spin-${CSS_SCOPE} 1.2s linear infinite;\n  }\n  @keyframes spin-${CSS_SCOPE} {\n    to { transform: rotate(360deg); }\n  }\n  @keyframes slideFromRight-${CSS_SCOPE} {\n    0% {\n      transform: translateX(100vw);\n    }\n    100% {\n      transform: translateX(0);\n    }\n  }\n  @keyframes slideToRight-${CSS_SCOPE} {\n    100% {\n      transform: translateX(100vw);\n      display: none;\n    }\n  }\n`;\n\nexport class VTAugment {\n\n    constructor(\n      public _container: HTMLElement,\n      public _options: VTAugmentOptions) {\n        VTAugment.createStyleSheet();\n        VTAugment.getIframe(_container);\n\n        _container.classList.add(`vt-augment-${CSS_SCOPE}`);\n\n        if (_options.background) {\n          _container.style.background = _options.background;\n        }\n\n        if (!_options.mode || _options.mode === 'drawer') {\n          _container.classList.add('drawer');\n        }\n\n        document.body.addEventListener('click', e => {\n          if (e.target !== _container) {\n            this.closeDrawer();\n          }\n        });\n\n        window.addEventListener('message', (event: any) => {\n        if (event.data === 'VTAUGMENT:READY') {\n          this.loading(false);\n        }\n      });\n      }\n\n    static factory(container: HTMLElement = null, options: VTAugmentOptions = {}) { return new VTAugment(container, options) }\n\n    load(url: string) {\n      const _iframe: HTMLIFrameIE11Compatible = VTAugment.getIframe(\n          this._container);\n      // iframe html injection not supported, fallback traditional url load\n      if (!('srcdoc' in _iframe)) {\n        this.loading(true);\n        _iframe.src = url;\n        return this;\n      }\n\n      let html = lscache.get(url);\n\n      // html not found in cache neither in fetching process, try to preload it\n      if (!html) {\n        this.loading(true);\n        this.preload(url);\n      }\n\n      // html is ready for the iframe injection\n      if (html !== 'fetching') {\n        _iframe.srcdoc = html;\n        return this;\n      }\n\n      // html is still fetching so polling until it is ready\n      if (html === 'fetching') {\n        this.loading(true);\n        const intervalRef = setInterval(() => {\n          html = lscache.get(url);\n\n          if (html && html !== 'fetching') {\n            clearInterval(intervalRef);\n            _iframe.srcdoc = html;\n            this.loading(false);\n          } else if (html === null) {\n            clearInterval(intervalRef);\n            _iframe.src = url;\n          }\n        }, 200);\n      }\n\n      return this;\n    }\n\n    preload(url: string) {\n      const _iframe: HTMLIFrameIE11Compatible = VTAugment.getIframe(\n          this._container);\n\n      // Avoid caching if browser doesn't support iframe content injection\n      if (_iframe.srcdoc === undefined) {\n        return;\n      }\n\n      const html = lscache.get(url);\n\n      if (!html) {\n        lscache.set(url, 'fetching', 1);\n        VTAugment.getHtmlAjax(url);\n      }\n    }\n\n    openDrawer() {\n      this._container.setAttribute('opened', '');\n      return this;\n    }\n\n    closeDrawer() {\n      this._container.removeAttribute('opened');\n      return this;\n    }\n\n    listen() {\n      console.error('listen: Not implemented yet');\n      return this;\n    }\n\n    loading(active: boolean) {\n      const _spinner = VTAugment.getSpinner(this._container);\n      const _iframe = VTAugment.getIframe(this._container);\n      _spinner.style.display = active ? 'block' : 'none';\n      _iframe.style.display = active ? 'none' : 'block';\n      return this;\n    }\n\n    private static createStyleSheet() {\n      const _stylesheet = document.createElement('style');\n      _stylesheet.innerHTML = CSS_STYLESHEET;\n      document.body.appendChild(_stylesheet);\n    }\n\n    private static getIframe(container: HTMLElement) {\n      let _iframe: HTMLIFrameIE11Compatible = container.querySelector('iframe');\n\n      if (!_iframe) {\n        _iframe = document.createElement('iframe');\n        _iframe.style.width = '100%';\n        _iframe.style.height = '100%';\n        _iframe.setAttribute('frameborder', '0');\n        container.appendChild(_iframe);\n      }\n\n      return _iframe;\n    }\n\n    private static getSpinner(container: HTMLElement) {\n      let _spinner: HTMLElement = container.querySelector('div.spinner');\n\n      if (!_spinner) {\n        _spinner = document.createElement('div');\n        _spinner.classList.add('spinner');\n        container.appendChild(_spinner);\n      }\n\n      return _spinner;\n    }\n\n    private static getHtmlAjax(url: string) {\n      const xmlhr = new XMLHttpRequest();\n\n      xmlhr.onreadystatechange = function () {\n        if (xmlhr.readyState === XMLHttpRequest.DONE) {\n          if (xmlhr.status === 200) {\n            lscache.set(url, xmlhr.response, 60);\n          } else {\n            lscache.remove(url);\n          }\n        }\n      };\n\n      xmlhr.open(\"GET\", url, true);\n      xmlhr.send();\n    }\n}\n"]}